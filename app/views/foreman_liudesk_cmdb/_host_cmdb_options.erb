<%-
  item = %w[hosts discovered_hosts].include?(controller_name) ? @host : @hostgroup
  facet = item&.liudesk_cmdb_facet

  inherited = false
  if !item&.persisted?
    hostgroup = @hostgroup || @host&.hostgroup
    inherited = facet.nil?
    inherited ||= true if hostgroup&.inherited_facet_attributes(Facets.registered_facets[:liudesk_cmdb_facet])&.any?

    facet ||= item&.build_passwordstate_facet(hostgroup.inherited_facet_attributes(Facets.registered_facets[:liudesk_cmdb_facet])) if inherited && hostgroup
  end
-%>

<%= fields_for item do |f| %>
<%= f.fields_for 'liudesk_cmdb_facet_attributes' do |f| %>
<%-
    servers = []
    begin
      servers = LiudeskCMDBServer.all.map do |server|
        [ server.id, server.name ]
      end
    rescue StandardError => e
-%>
<!--
Errors occured during rendering;
<%= e.class %>: <%= e %>
<%= e.backtrace.join "\n" %>
-->
<%-
    end

    server_id = facet&.liudesk_cmdb_server_id
    asset_type = facet&.asset_type
-%>
<%= select_f(f, :liudesk_cmdb_server_id, servers, :first, :last,
      { include_blank: true,
        selected: server_id,
        disable_button: _(HostsAndHostgroupsHelper::INHERIT_TEXT),
        disable_button_enabled: inherited,
      },
      { disabled: servers.empty?,
        help_inline: :indicator,
        label: _('CMDB Asset Storage Location'),
        label_help_options: { data: { placement: 'top' } },
      })
%>
<%= select_f(f, :asset_type, [ ['server', 'Server'], ['client', 'Client'] ], :first, :last,
      { include_blank: true,
        selected: asset_type,
        disable_button: _(HostsAndHostgroupsHelper::INHERIT_TEXT),
        disable_button_enabled: inherited,
      },
      { help_inline: :indicator,
        label: _('CMDB Asset Type'),
        label_help_options: { data: { placement: 'top' } },
      })
%>
<%-
  end
end
-%>
